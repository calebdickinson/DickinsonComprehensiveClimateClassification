<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L6C1HZ2LBZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-L6C1HZ2LBZ');
  </script>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/styles.css">
  <title></title>
  <style>
  /* Generic hidden class â€“ JS will remove this when content loads successfully */
  .hidden {
    display: none !important;
  }

  /* Cities section still starts hidden (uses the same class or ID override if needed) */
  #cities {
    display: none !important;
  }

  #landscape_caption {
    margin-top: 0.2em;
    font-family: Georgia, serif;
    color: #222222;
    line-height: 1.5;
    font-size: 1.2em;
  }

  </style>
</head>
<body>
  <div id="header">
    <h1>The Dickinson Comprehensive Climate Classification System</h1>
  </div>

  <nav>
    <a href="home.html">Home</a>
    <a href="classification.html">Classification</a>
    <a href="maps.html">Maps</a>
    <a href="about.html">About</a>
  </nav>

  <main>
    <h1 id="climate_name"></h1>

    <div class="climate-code">
      <h2><strong id="climate_exists"></strong></h2>
    </div>

    <div class="buttons-with-code">
      <div class="buttons-group">
        <button class="warmer" id="climate_go_to_hotter_summer"><-- Warmer Summers</button>
        <button class="warmer" id="climate_go_to_hotter_winter"><-- Warmer Winters</button>
      </div>
      <div class="climate-code">
        <h2>Climate Code: <strong id="climate_code"></strong></h2>
      </div>
      <div class="buttons-group buttons-group_right">
        <button class="colder" id="climate_go_to_colder_summer">Colder Summers --></button>
        <button class="colder" id="climate_go_to_colder_winter">Colder Winters --></button>
      </div>
    </div>

    <div class="box" id="ariditySection" hidden>
      <div class="ariditybox-border-outer">
        <div class="ariditybox-border-inner">
          <div class="ariditybox-grid">
            <button id="climate_go_to_humid"           class="ariditybox ariditybox-humid">Humid (H)</button>
            <button id="climate_go_to_semihumid"       class="ariditybox ariditybox-semihumid">Semihumid (G)</button>
            <button id="climate_go_to_monsoon"         class="ariditybox ariditybox-monsoon">Monsoon<br><br>(W)</button>
            <button id="climate_go_to_mediterranean"   class="ariditybox ariditybox-mediterranean">Mediter-<br>ranean<br><br>(M)</button>
            <button id="climate_go_to_semiarid"        class="ariditybox ariditybox-semiarid">Semiarid (S)</button>
            <button id="climate_go_to_arid_desert"     class="ariditybox ariditybox-arid-desert">Arid Desert (D)</button>
          </div>
        </div>
      </div>
    </div>

    <div id="landscapes">
      <img id="climate_landscape" alt="landscape in this climate">
      <p id="landscape_caption" class="hidden"></p>
    </div>

    <!-- Legend shown only for climate group pages -->
    <div id="groupLegend" style="max-width:800px; margin:0 auto 10px; display:block;">
      <img id="group_legend_img" alt="Climate group maps legend" style="max-width:100%; height:auto;">
    </div>

    <!-- Global maps -->
    <div id="map1">
      <h3 class="map-caption">Global distribution of this climate<br>(1981 - 2010 normals)</h3>
      <img id="climate_map_1" alt="World climate map (1981 - 2010 normals)">
    </div>
    <div id="map2">
      <h3 class="map-caption">Global distribution of this climate<br>(2011 - 2040 High Emissions normals)</h3>
      <img id="climate_map_2" alt="World climate map (2011 - 2040 High Emissions normals)">
    </div>
    <div id="map3">
      <h3 class="map-caption">Global distribution of this climate<br>(2041 - 2070 High Emissions normals)</h3>
      <img id="climate_map_3" alt="World climate map (2041 - 2070 High Emissions normals)">
    </div>
    <div id="map4">
      <h3 class="map-caption">Global distribution of this climate<br>(2071 - 2100 High Emissions normals)</h3>
      <img id="climate_map_4" alt="World climate map (2071 - 2100 High Emissions normals)">
    </div>

    <!-- USA maps -->
    <div id="map1usa">
      <h3 class="map-caption">United States distribution of this climate<br>(1981 - 2010 normals)</h3>
      <img id="climate_map_1_usa" alt="United States climate map (1981 - 2010 normals)">
    </div>
    <div id="map2usa">
      <h3 class="map-caption">United States distribution of this climate<br>(2011 - 2040 High Emissions normals)</h3>
      <img id="climate_map_2_usa" alt="United States climate map (2011 - 2040 High Emissions normals)">
    </div>
    <div id="map3usa">
      <h3 class="map-caption">United States distribution of this climate<br>(2041 - 2070 High Emissions normals)</h3>
      <img id="climate_map_3_usa" alt="United States climate map (2041 - 2070 High Emissions normals)">
    </div>
    <div id="map4usa">
      <h3 class="map-caption">United States distribution of this climate<br>(2071 - 2100 High Emissions normals)</h3>
      <img id="climate_map_4_usa" alt="United States climate map (2071 - 2100 High Emissions normals)">
    </div>

    <!-- Europe maps -->
    <div id="map1europe">
      <h3 class="map-caption">Europe distribution of this climate<br>(1981 - 2010 normals)</h3>
      <img id="climate_map_1_europe" alt="Europe climate map (1981 - 2010 normals)">
    </div>
    <div id="map2europe">
      <h3 class="map-caption">Europe distribution of this climate<br>(2011 - 2040 High Emissions normals)</h3>
      <img id="climate_map_2_europe" alt="Europe climate map (2011 - 2040 High Emissions normals)">
    </div>
    <div id="map3europe">
      <h3 class="map-caption">Europe distribution of this climate<br>(2041 - 2070 High Emissions normals)</h3>
      <img id="climate_map_3_europe" alt="Europe climate map (2041 - 2070 High Emissions normals)">
    </div>
    <div id="map4europe">
      <h3 class="map-caption">Europe distribution of this climate<br>(2071 - 2100 High Emissions normals)</h3>
      <img id="climate_map_4_europe" alt="Europe climate map (2071 - 2100 High Emissions normals)">
    </div>
  </main>

  <script>
    // --- helpers ---
    function change_climate(nextCode) {
      window.location.href = window.location.pathname + '?code=' + nextCode;
    }

    // Only unhide a section if its image actually loads (with cache busting)
    function wireSection(sectionId, imgId, url) {
      const section = document.getElementById(sectionId);
      const img = document.getElementById(imgId);
      if (!section || !img) return;

      section.style.display = 'none';
      if (!url || String(url).trim() === '') return;

      const busted = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();

      img.onload = () => {
        if (img.naturalWidth > 0 && img.naturalHeight > 0) {
          section.style.display = '';
        } else {
          section.remove();
        }
      };
      img.onerror = () => section.remove();
      img.decoding = 'async';
      img.loading  = 'eager';
      img.src = busted;
    }

    // --- main ---
    const codeParam = new URLSearchParams(location.search).get('code');
    if (!codeParam) throw new Error("No climate code specified in URL");

    fetch('data/data.json?v=' + Date.now(), { cache: 'no-store' })
      .then(r => r.json())
      .then(data => {
        // exact match first, then case-insensitive fallback
        let climate = data[codeParam];
        if (!climate) {
          const wanted = codeParam.toLowerCase();
          const k = Object.keys(data).find(key => key.toLowerCase() === wanted);
          if (k) climate = data[k];
        }
        if (!climate) throw new Error(`Climate code '${codeParam}' not found in data.json`);

        const climate_code = climate.code; // canonical case from data.json

        document.getElementById('climate_name').textContent =
          climate.name + (climate.group ? " Climate Group" : " Climate");
        document.getElementById('climate_code').textContent = climate_code;

        const isGroup = !!climate.group;

        if (isGroup) {
          const legendDiv = document.getElementById('groupLegend');
          const legendImg = document.getElementById('group_legend_img');

          legendImg.src = 'images/climategrouplegend.png';  // exact path
          legendDiv.style.display = '';                     // unhide
        }

        // Hide/remove legend entirely for non-group pages
        if (!isGroup) {
          const legendDiv = document.getElementById('groupLegend');
          if (legendDiv) legendDiv.remove(); // or legendDiv.style.display = 'none';
        }

        document.querySelectorAll('.map-caption').forEach(caption => {
          caption.innerHTML = caption.innerHTML.replace(
            'Global distribution of this climate',
            isGroup ? 'Global distribution of this climate group' : 'Global distribution of this climate'
          ).replace(
            'United States distribution of this climate',
            isGroup ? 'United States distribution of this climate group' : 'United States distribution of this climate'
          ).replace(
            'Europe distribution of this climate',
            isGroup ? 'Europe distribution of this climate group' : 'Europe distribution of this climate'
          );
        });

        // Nav buttons
        [
          ['climate_go_to_hotter_summer','go_to_hotter_summer'],
          ['climate_go_to_colder_summer','go_to_colder_summer'],
          ['climate_go_to_hotter_winter','go_to_hotter_winter'],
          ['climate_go_to_colder_winter','go_to_colder_winter'],
        ].forEach(([btnId, key]) => {
          const btn = document.getElementById(btnId);
          const dest = climate[key];
          if (dest && dest !== "False") btn.onclick = () => change_climate(dest);
          else btn.disabled = true;
        });

        // Aridity buttons (H, G, W, M, S, D)
        [
          ['climate_go_to_humid',         'go_to_humid'],
          ['climate_go_to_semihumid',     'go_to_semihumid'],
          ['climate_go_to_monsoon',       'go_to_monsoon'],
          ['climate_go_to_mediterranean', 'go_to_mediterranean'],
          ['climate_go_to_semiarid',      'go_to_semiarid'],
          ['climate_go_to_arid_desert',   'go_to_arid_desert'],
        ].forEach(([btnId, key]) => {
          const btn  = document.getElementById(btnId);
          if (!btn) return; // safety

          const dest = climate[key];
          if (dest && dest !== "False") {
            btn.onclick = () => change_climate(dest);
          } else {
            btn.disabled = true;
          }
        });

        // --- Landscapes: load exactly like maps ---
        const LAND_DIR = 'images/landscapes';
        const landscapeDefault = `${LAND_DIR}/${climate_code}.jpg`;
        const landscapePath = (climate.landscape && climate.landscape.trim()) || landscapeDefault;

        // Use the same helper the maps use (wireSection does the cache-busting and show/hide)
        wireSection('landscapes', 'climate_landscape', landscapePath);

        // --- Simple landscape caption loader (HTML allowed) ---
        fetch('data/landscapetext.json?v=' + Date.now(), { cache: 'no-store' })
          .then(r => r.json())
          .then(texts => {
            const caption = texts[climate_code]; // key must match canonical climate_code
            if (caption) {
              const capEl = document.getElementById('landscape_caption');
              if (capEl) {
                capEl.innerHTML = caption; // use innerHTML so <a> links render
                capEl.classList.remove('hidden');
              }
            }
          })
          .catch(err => console.warn('No landscape caption found:', err));

        // Build default map paths using exact case
        const MAP_DIR = 'images/maps';
        const g = n => `${MAP_DIR}/${climate_code}-map${n}.png`;
        const u = n => `${MAP_DIR}/${climate_code}-map${n}usa.png`;
        const e = n => `${MAP_DIR}/${climate_code}-map${n}europe.png`;

        // Global
        wireSection('map1', 'climate_map_1',  climate.map1  || g(1));
        wireSection('map2', 'climate_map_2',  climate.map2  || g(2));
        wireSection('map3', 'climate_map_3',  climate.map3  || g(3));
        wireSection('map4', 'climate_map_4',  climate.map4  || g(4));
        // USA
        wireSection('map1usa','climate_map_1_usa', climate.map1usa || u(1));
        wireSection('map2usa','climate_map_2_usa', climate.map2usa || u(2));
        wireSection('map3usa','climate_map_3_usa', climate.map3usa || u(3));
        wireSection('map4usa','climate_map_4_usa', climate.map4usa || u(4));
        // Europe
        wireSection('map1europe','climate_map_1_europe', climate.map1europe || e(1));
        wireSection('map2europe','climate_map_2_europe', climate.map2europe || e(2));
        wireSection('map3europe','climate_map_3_europe', climate.map3europe || e(3));
        wireSection('map4europe','climate_map_4_europe', climate.map4europe || e(4));

        // Aridity chooser visibility (unrelated to maps)
        const aridityTargets = [
          climate.go_to_humid, climate.go_to_semihumid,
          climate.go_to_monsoon, climate.go_to_mediterranean,
          climate.go_to_semiarid, climate.go_to_arid_desert
        ];
        const anyAridity = aridityTargets.some(v => v && v !== "False");
        document.getElementById('ariditySection').hidden = !(climate.group && climate.exists && anyAridity);

        // Non-existent page: show banner and remove optional UI
        if (!climate.exists) {
          document.getElementById('climate_exists').textContent =
            `THIS ${climate.group ? 'CLIMATE GROUP' : 'CLIMATE'} DOES NOT EXIST`;
          [
            'landscapes', 'groupLegend',
            'map1','map2','map3','map4',
            'map1usa','map2usa','map3usa','map4usa',
            'map1europe','map2europe','map3europe','map4europe',
            'ariditySection'
          ].forEach(id => { const el = document.getElementById(id); if (el) el.remove(); });
        }
      })
      .catch(err => { console.error(err); alert(err.message); });
  </script>
</body>
</html>
