<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L6C1HZ2LBZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-L6C1HZ2LBZ');
  </script>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/styles.css">
    <title></title>
</head>
<body>
  <div id="header">
    <h1>The Dickinson Comprehensive Climate Classification System</h1>
  </div>
  <nav>
    <a href="home.html">Home</a>
    <a href="classification.html">Classification</a>
    <a href="maps.html">Maps</a>
    <a href="about.html">About</a>
  </nav>
  <main>
    <h1 id="climate_name"></h1>

    <div class="climate-code">
        <h2><strong id='climate_exists'></strong></h2>
    </div>

    <div class="buttons-with-code">
      <div class="buttons-group">
        <button class="warmer" id="climate_go_to_hotter_summer"><-- Warmer Summers</button>
        <button class="warmer" id="climate_go_to_hotter_winter"><-- Warmer Winters</button>
      </div>
      <div class="climate-code">
        <h2>Climate Code: <strong id="climate_code"></strong></h2>
      </div>
      <div class="buttons-group buttons-group_right">
        <button class="colder" id="climate_go_to_colder_summer">Colder Summers --></button>
        <button class="colder" id="climate_go_to_colder_winter">Colder Winters --></button>
      </div>
    </div>

    <div class="box" id="ariditySection">
        <div class="ariditybox-border-outer">
            <div class="ariditybox-border-inner">
                <div class="ariditybox-grid">
                    <button id="climate_go_to_humid" class="ariditybox ariditybox-humid">Humid (H)</button>
                    <button id="climate_go_to_semihumid" class="ariditybox ariditybox-semihumid">Semihumid (G)</button>
                    <button id="climate_go_to_monsoon" class="ariditybox ariditybox-monsoon">Monsoon<br><br>(W)</button>
                    <button id="climate_go_to_mediterranean" class="ariditybox ariditybox-mediterranean">Mediter-<br>ranean<br><br>(M)</button>
                    <button id="climate_go_to_semiarid" class="ariditybox ariditybox-semiarid">Semiarid (S)</button>
                    <button id="climate_go_to_arid_desert" class="ariditybox ariditybox-arid-desert">Arid Desert (D)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="landscapes">
      <img id="climate_landscape" src="" alt="landscape in this climate">
    </div>

    <div id="cities">
      <div id="cities_1900s" class="cities-block">
        <h3>Cities with this climate (1961â€“1990 normals)</h3>
        <ul id="climate_cities_1900s"></ul>
      </div>

      <div id="cities_2025" class="cities-block">
        <h3>Cities with this climate (2025)</h3>
        <ul id="climate_cities_2025"></ul>
      </div>

      <div id="cities_2100" class="cities-block">
        <h3>Cities with this climate (2100)</h3>
        <ul id="climate_cities_2100"></ul>
      </div>
    </div>

    <br><br><p><i id="distribution_message"></i></p>

    <div id="1900s">
      <h3>Global distribution of this climate (1961-1990 normals)</h3>
      <img id="climate_map_1900s" src="" alt="climate map (1961-1990 normals)">
    </div>
    
    <div id="2025">
      <h3>Global distribution of this climate (2025)</h3>
      <img id="climate_map_2025" src="" alt="climate map in 2025">
    </div>

    <div id="2100">
      <h3>Global distribution of this climate (2100)</h3>
      <img id="climate_map_2100" src="" alt="climate map in 2100">
    </div>

  </main>


  <!-- get data for specific climate code -->
  <script>
    const code = new URLSearchParams(location.search).get('code');

    if (!code) {
        throw new Error("No climate code specified in URL");
    }

    fetch('data/data.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const climate = data[code];
            const climate_code = climate['code'];
            const climate_name = climate['name'];
            const climate_exists = climate['exists'];
            const climate_group = climate['group'];
            const climate_go_to_humid = climate['go_to_humid'];
            const climate_go_to_semihumid = climate['go_to_semihumid'];
            const climate_go_to_monsoon = climate['go_to_monsoon'];
            const climate_go_to_mediterranean = climate['go_to_mediterranean'];
            const climate_go_to_semiarid = climate['go_to_semiarid'];
            const climate_go_to_arid_desert = climate['go_to_arid_desert'];
            const climate_go_to_hotter_summer = climate['go_to_hotter_summer'];
            const climate_go_to_colder_summer = climate['go_to_colder_summer'];
            const climate_go_to_hotter_winter = climate['go_to_hotter_winter'];
            const climate_go_to_colder_winter = climate['go_to_colder_winter'];
            const climate_cities = climate['cities'];   // <-- define it
                renderCities(climate_cities);    
            const climate_map_2025 = climate['map_2025'];
            const climate_map_2100 = climate['map_2100'];
            const climate_map_1900s = climate['map_1900s'];
            const climate_landscape = climate['landscape'];
            const distribution_message = "Please note that map data for oceans and Antarctica is not available.";

            if (!climate) throw new Error(`Climate data for code "${code}" not found`);

            document.getElementById('climate_name').textContent = climate_name;
            document.getElementById('climate_code').textContent = climate_code;
            document.getElementById('distribution_message').textContent = distribution_message;

            if (!climate_exists) {
              document.getElementById('climate_exists').textContent = "THIS CLIMATE DOES NOT EXIST";

              // Hide everything except the message, climate code, and navigation buttons
              document.getElementById('landscapes').style.display = 'none';
              document.getElementById('cities').style.display = 'none';
              document.getElementById('distribution_message').style.display = 'none';
              document.getElementById('1900s').style.display = 'none';
              document.getElementById('2025').style.display = 'none';
              document.getElementById('2100').style.display = 'none';
            } else {
              document.getElementById('climate_exists').style.display = 'none';
            }

            if (climate_group) document.getElementById('ariditySection').style.display = 'block';
            else document.getElementById('ariditySection').style.display = 'none';

            function renderCities(cities) {
              // Support both old (flat array with "(...)" suffixes) and future (grouped) formats.
              // If `cities` is already an object like { "1900s": [...], "2025": [...], "2100": [...] } use it directly.
              let groups = { "1900s": [], "2025": [], "2100": [] };

              if (Array.isArray(cities)) {
                // Parse the time suffix and strip it from the display text
                const re = /\s*\((1961-1990 normals|2025|2100)\)\s*$/;
                cities.forEach((entry) => {
                  if (typeof entry !== 'string') return;
                  const m = entry.match(re);
                  if (m) {
                    const period = m[1] === '1961-1990 normals' ? '1900s' : m[1];
                    const clean = entry.replace(re, '');
                    groups[period].push(clean);
                  } else {
                    // If no suffix, drop it into 2025 by default (or choose another default)
                    groups['2025'].push(entry);
                  }
                });
              } else if (cities && typeof cities === 'object') {
                // Already grouped (optional future backend format)
                if (Array.isArray(cities['1900s'])) groups['1900s'] = cities['1900s'];
                if (Array.isArray(cities['2025']))  groups['2025']  = cities['2025'];
                if (Array.isArray(cities['2100']))  groups['2100']  = cities['2100'];
              }

              // Helper to render one group into a UL; hide block if empty
              function fillList(blockId, listId, arr) {
                const block = document.getElementById(blockId);
                const ul = document.getElementById(listId);
                if (!arr || arr.length === 0) {
                  if (block) block.style.display = 'none';
                  return;
                }
                if (ul) {
                  ul.innerHTML = ''; // clear
                  arr.sort((a, b) => a.localeCompare(b)).forEach((city) => {
                    const li = document.createElement('li');
                    li.textContent = city; // dates already stripped
                    ul.appendChild(li);
                  });
                }
              }

              fillList('cities_1900s', 'climate_cities_1900s', groups['1900s']);
              fillList('cities_2025',  'climate_cities_2025',  groups['2025']);
              fillList('cities_2100',  'climate_cities_2100',  groups['2100']);

              // If all three are empty, hide the whole section
              if (groups['1900s'].length + groups['2025'].length + groups['2100'].length === 0) {
                const whole = document.getElementById('cities');
                if (whole) whole.style.display = 'none';
              }
            }


            function change_climate(code) {
                window.location.href = window.location.pathname + '?code=' + code;
            }

            function disable_or_omit(value) {
                return value === "False" || value === "false" || value === false || value === "" || value === undefined || value === null
            }

            if (disable_or_omit(climate_go_to_hotter_summer)) document.getElementById('climate_go_to_hotter_summer').disabled = true;
            else document.getElementById('climate_go_to_hotter_summer').onclick = () => change_climate(climate_go_to_hotter_summer);
            if (disable_or_omit(climate_go_to_colder_summer)) document.getElementById('climate_go_to_colder_summer').disabled = true;
            else document.getElementById('climate_go_to_colder_summer').onclick = () => change_climate(climate_go_to_colder_summer);
            if (disable_or_omit(climate_go_to_hotter_winter)) document.getElementById('climate_go_to_hotter_winter').disabled = true;
            else document.getElementById('climate_go_to_hotter_winter').onclick = () => change_climate(climate_go_to_hotter_winter);
            if (disable_or_omit(climate_go_to_colder_winter)) document.getElementById('climate_go_to_colder_winter').disabled = true;
            else document.getElementById('climate_go_to_colder_winter').onclick = () => change_climate(climate_go_to_colder_winter);

            if (disable_or_omit(climate_go_to_humid)) document.getElementById('climate_go_to_humid').disabled = true;
            else document.getElementById('climate_go_to_humid').onclick = () => change_climate(climate_go_to_humid);
            if (disable_or_omit(climate_go_to_semihumid)) document.getElementById('climate_go_to_semihumid').disabled = true;
            else document.getElementById('climate_go_to_semihumid').onclick = () => change_climate(climate_go_to_semihumid);
            if (disable_or_omit(climate_go_to_monsoon)) document.getElementById('climate_go_to_monsoon').disabled = true;
            else document.getElementById('climate_go_to_monsoon').onclick = () => change_climate(climate_go_to_monsoon);
            if (disable_or_omit(climate_go_to_mediterranean)) document.getElementById('climate_go_to_mediterranean').disabled = true;
            else document.getElementById('climate_go_to_mediterranean').onclick = () => change_climate(climate_go_to_mediterranean);
            if (disable_or_omit(climate_go_to_semiarid)) document.getElementById('climate_go_to_semiarid').disabled = true;
            else document.getElementById('climate_go_to_semiarid').onclick = () => change_climate(climate_go_to_semiarid);
            if (disable_or_omit(climate_go_to_arid_desert)) document.getElementById('climate_go_to_arid_desert').disabled = true;
            else document.getElementById('climate_go_to_arid_desert').onclick = () => change_climate(climate_go_to_arid_desert);

            const images = [
              { id: 'climate_landscape', src: climate_landscape, alt: 'landscape in this climate' },
              { id: 'climate_map_1900s', src: climate_map_1900s, alt: 'climate map (1961-1990 normals)' },
              { id: 'climate_map_2025',  src: climate_map_2025,  alt: 'climate map in 2025' },
              { id: 'climate_map_2100',  src: climate_map_2100,  alt: 'climate map in 2100' }
            ];


            const FALLBACK_MAP = 'images/maps/nothing.png';
            // No idea why the fallback landscape makes it work
            // but the code crashes if it doesn't have both maps and landscape.
            const FALLBACK_LANDSCAPE = 'images/landscapes/nothing.png'; // optional

            function setImgWithFallback(el, url, alt, fallback) {
              if (!el) return;
              el.alt = alt;

              // prevent infinite loop if fallback is missing
              el.onerror = () => { el.onerror = null; el.src = fallback; };

              // if URL is missing/empty, use fallback immediately
              el.src = (url && url.trim() !== '') ? url : fallback;
            }

            images.forEach(({ id, src, alt }) => {
              const el = document.getElementById(id);
              // choose correct fallback
              const fallback = id === 'climate_landscape' ? FALLBACK_LANDSCAPE : FALLBACK_MAP;
              setImgWithFallback(el, src, alt, fallback);
            });
        })
        .catch(error => {
            throw new Error("Error loading climate data: " + error.message);
        })
  </script>
</body>
</html>