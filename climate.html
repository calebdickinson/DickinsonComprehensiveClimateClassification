<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L6C1HZ2LBZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-L6C1HZ2LBZ');
  </script>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/styles.css">
  <title></title>
  <style>
    /* start every optional section hidden; JS will unhide on successful load */
    #cities,
    #map1, #map2, #map3, #map4,
    #map1usa, #map2usa, #map3usa, #map4usa,
    #map1europe, #map2europe, #map3europe, #map4europe {
      display: none;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>The Dickinson Comprehensive Climate Classification System</h1>
  </div>

  <nav>
    <a href="home.html">Home</a>
    <a href="classification.html">Classification</a>
    <a href="maps.html">Maps</a>
    <a href="about.html">About</a>
  </nav>

  <main>
    <h1 id="climate_name"></h1>

    <div class="climate-code">
      <h2><strong id="climate_exists"></strong></h2>
    </div>

    <div class="buttons-with-code">
      <div class="buttons-group">
        <button class="warmer" id="climate_go_to_hotter_summer"><-- Warmer Summers</button>
        <button class="warmer" id="climate_go_to_hotter_winter"><-- Warmer Winters</button>
      </div>
      <div class="climate-code">
        <h2>Climate Code: <strong id="climate_code"></strong></h2>
      </div>
      <div class="buttons-group buttons-group_right">
        <button class="colder" id="climate_go_to_colder_summer">Colder Summers --></button>
        <button class="colder" id="climate_go_to_colder_winter">Colder Winters --></button>
      </div>
    </div>

    <div class="box" id="ariditySection" hidden>
      <div class="ariditybox-border-outer">
        <div class="ariditybox-border-inner">
          <div class="ariditybox-grid">
            <button id="climate_go_to_humid"           class="ariditybox ariditybox-humid">Humid (H)</button>
            <button id="climate_go_to_semihumid"       class="ariditybox ariditybox-semihumid">Semihumid (G)</button>
            <button id="climate_go_to_monsoon"         class="ariditybox ariditybox-monsoon">Monsoon<br><br>(W)</button>
            <button id="climate_go_to_mediterranean"   class="ariditybox ariditybox-mediterranean">Mediter-<br>ranean<br><br>(M)</button>
            <button id="climate_go_to_semiarid"        class="ariditybox ariditybox-semiarid">Semiarid (S)</button>
            <button id="climate_go_to_arid_desert"     class="ariditybox ariditybox-arid-desert">Arid Desert (D)</button>
          </div>
        </div>
      </div>
    </div>

    <div id="landscapes">
      <img id="climate_landscape" src="" alt="landscape in this climate" style="display:none;">
    </div>

    <!-- Cities (disabled) -->
    <div id="cities"></div>

    <!-- Global maps -->
    <div id="map1">
      <h3>Global distribution of this climate<br>(1981 - 2010 normals)</h3>
      <img id="climate_map_1" alt="World climate map (1981 - 2010 normals)">
    </div>
    <div id="map2">
      <h3>Global distribution of this climate<br>(2011 - 2040 High Emissions normals)</h3>
      <img id="climate_map_2" alt="World climate map (2011 - 2040 High Emissions normals)">
    </div>
    <div id="map3">
      <h3>Global distribution of this climate<br>(2041 - 2070 High Emissions normals)</h3>
      <img id="climate_map_3" alt="World climate map (2041 - 2070 High Emissions normals)">
    </div>
    <div id="map4">
      <h3>Global distribution of this climate<br>(2071 - 2100 High Emissions normals)</h3>
      <img id="climate_map_4" alt="World climate map (2071 - 2100 High Emissions normals)">
    </div>

    <!-- USA maps -->
    <div id="map1usa">
      <h3>United States distribution of this climate<br>(1981 - 2010 normals)</h3>
      <img id="climate_map_1_usa" alt="United States climate map (1981 - 2010 normals)">
    </div>
    <div id="map2usa">
      <h3>United States distribution of this climate<br>(2011 - 2040 High Emissions normals)</h3>
      <img id="climate_map_2_usa" alt="United States climate map (2011 - 2040 High Emissions normals)">
    </div>
    <div id="map3usa">
      <h3>United States distribution of this climate<br>(2041 - 2070 High Emissions normals)</h3>
      <img id="climate_map_3_usa" alt="United States climate map (2041 - 2070 High Emissions normals)">
    </div>
    <div id="map4usa">
      <h3>United States distribution of this climate<br>(2071 - 2100 High Emissions normals)</h3>
      <img id="climate_map_4_usa" alt="United States climate map (2071 - 2100 High Emissions normals)">
    </div>

    <!-- Europe maps -->
    <div id="map1europe">
      <h3>Europe distribution of this climate<br>(1981 - 2010 normals)</h3>
      <img id="climate_map_1_europe" alt="Europe climate map (1981 - 2010 normals)">
    </div>
    <div id="map2europe">
      <h3>Europe distribution of this climate<br>(2011 - 2040 High Emissions normals)</h3>
      <img id="climate_map_2_europe" alt="Europe climate map (2011 - 2040 High Emissions normals)">
    </div>
    <div id="map3europe">
      <h3>Europe distribution of this climate<br>(2041 - 2070 High Emissions normals)</h3>
      <img id="climate_map_3_europe" alt="Europe climate map (2041 - 2070 High Emissions normals)">
    </div>
    <div id="map4europe">
      <h3>Europe distribution of this climate<br>(2071 - 2100 High Emissions normals)</h3>
      <img id="climate_map_4_europe" alt="Europe climate map (2071 - 2100 High Emissions normals)">
    </div>
  </main>

  <script>
    const code = new URLSearchParams(location.search).get('code');
    if (!code) throw new Error("No climate code specified in URL");

    function change_climate(nextCode) {
      window.location.href = window.location.pathname + '?code=' + nextCode;
    }

    // Preload an image; resolve(true) if it loads, else resolve(false)
    function testImage(url) {
      return new Promise((resolve) => {
        if (!url || String(url).trim() === '') return resolve(false);
        const img = new Image();
        img.onload  = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
      });
    }

    // Show a section only if its image actually loads
    async function showSectionIfImageLoads(sectionId, imgId, url) {
      const section = document.getElementById(sectionId);
      const imgEl   = document.getElementById(imgId);
      if (!section || !imgEl) return;

      const ok = await testImage(url);
      if (ok) {
        imgEl.src = url;
        section.style.display = '';
      } else {
        section.style.display = 'none';
      }
    }

    fetch('data/data.json')
      .then(r => r.json())
      .then(async data => {
        const climate = data[code];
        if (!climate) throw new Error(`Climate code '${code}' not found in data.json`);

        const climate_code = climate['code']; // keep exact case
        document.getElementById('climate_name').textContent =
          climate['name'] + (climate['group'] ? " Climate Group" : " Climate");
        document.getElementById('climate_code').textContent = climate_code;

        // Nav buttons
        const btns = [
          ['climate_go_to_hotter_summer', 'go_to_hotter_summer'],
          ['climate_go_to_colder_summer', 'go_to_colder_summer'],
          ['climate_go_to_hotter_winter', 'go_to_hotter_winter'],
          ['climate_go_to_colder_winter', 'go_to_colder_winter'],
        ];
        btns.forEach(([id, key]) => {
          const el = document.getElementById(id);
          const dest = climate[key];
          if (dest && dest !== "False") el.onclick = () => change_climate(dest);
          else el.disabled = true;
        });

        // Landscape: show only if it loads
        const landscapeUrl = (climate['landscape'] && climate['landscape'].trim())
          ? climate['landscape'].trim()
          : `images/landscapes/${climate_code}.jpg`;
        if (await testImage(landscapeUrl)) {
          const l = document.getElementById('climate_landscape');
          l.src = landscapeUrl;
          l.style.display = '';
        }

        // Build expected paths (fallbacks) using exact code case
        const MAP_DIR = 'images/maps';
        const g = n => `${MAP_DIR}/${climate_code}-map${n}.png`;
        const u = n => `${MAP_DIR}/${climate_code}-map${n}usa.png`;
        const e = n => `${MAP_DIR}/${climate_code}-map${n}europe.png`;

        // Prefer explicit JSON paths; else derive
        await Promise.all([
          showSectionIfImageLoads('map1', 'climate_map_1', climate['map1'] || g(1)),
          showSectionIfImageLoads('map2', 'climate_map_2', climate['map2'] || g(2)),
          showSectionIfImageLoads('map3', 'climate_map_3', climate['map3'] || g(3)),
          showSectionIfImageLoads('map4', 'climate_map_4', climate['map4'] || g(4)),

          showSectionIfImageLoads('map1usa', 'climate_map_1_usa', climate['map1usa'] || u(1)),
          showSectionIfImageLoads('map2usa', 'climate_map_2_usa', climate['map2usa'] || u(2)),
          showSectionIfImageLoads('map3usa', 'climate_map_3_usa', climate['map3usa'] || u(3)),
          showSectionIfImageLoads('map4usa', 'climate_map_4_usa', climate['map4usa'] || u(4)),

          showSectionIfImageLoads('map1europe', 'climate_map_1_europe', climate['map1europe'] || e(1)),
          showSectionIfImageLoads('map2europe', 'climate_map_2_europe', climate['map2europe'] || e(2)),
          showSectionIfImageLoads('map3europe', 'climate_map_3_europe', climate['map3europe'] || e(3)),
          showSectionIfImageLoads('map4europe', 'climate_map_4_europe', climate['map4europe'] || e(4)),
        ]);

        // Aridity box visibility (unchanged logic)
        const aridityTargets = [
          climate['go_to_humid'],
          climate['go_to_semihumid'],
          climate['go_to_monsoon'],
          climate['go_to_mediterranean'],
          climate['go_to_semiarid'],
          climate['go_to_arid_desert'],
        ];
        const anyAridity = aridityTargets.some(v => v && v !== "False");
        document.getElementById('ariditySection').hidden = !(climate['group'] && climate['exists'] && anyAridity);

        // Existence banner & hard hide everything else if it “does not exist”
        if (!climate['exists']) {
          document.getElementById('climate_exists').textContent =
            `THIS ${climate['group'] ? 'CLIMATE GROUP' : 'CLIMATE'} DOES NOT EXIST`;
          [
            'landscapes','map1','map2','map3','map4',
            'map1usa','map2usa','map3usa','map4usa',
            'map1europe','map2europe','map3europe','map4europe',
            'ariditySection'
          ].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
        }
      })
      .catch(err => {
        console.error(err);
        alert(err.message);
      });
  </script>
</body>
</html>
