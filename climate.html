<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="favicon.png">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-L6C1HZ2LBZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    // We’ll send our own page_view after we know which climate is loaded
    gtag('config', 'G-L6C1HZ2LBZ', { send_page_view: false });
  </script>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="css/styles.css">
  <title></title>
  <style>

  .map-caption {
    text-align: center;
    margin-bottom: 20px;
  }

  button {
    width: 12rem;
    height: 2.5rem;
    font-size: 1.3rem;
    color: #222222;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    margin-left: 1%;
    margin-right: 1%;
  }

  .humid           { background: #008800; }
  .semihumid       { background: #00ff00; }
  .monsoon         { background: #ff00ff; }
  .mediterranean   { background: #fff000; }
  .semiarid        { background: #ff8800; }
  .arid            { background: #ff0000; }
  .cold            { background: #4444ff; }

  button:disabled {
    background: #444 !important;
    color: transparent !important;  /* hide text */
    cursor: default !important;
    pointer-events: none !important;
    transform: none !important;
  }

  .year-btn.disabled {
    background: #444 !important;
    color: transparent !important;
    cursor: default !important;
    pointer-events: none !important;
    transform: none !important;
  }

  button:hover {
    transform: scale(1.1);
  }

  .year-btn.active {
    border: 3px solid black !important;
  }

  .ariditybox.current {
    border: 3px solid black;
  }

  .buttons-with-code {
    display: grid;
    grid-template-columns: auto auto auto;
    align-items: center;
    justify-content: center;
    column-gap: 40px;
  }

  /* Generic hidden class – JS will remove this when content loads successfully */
  .hidden {
    display: none !important;
  }
  /* Cities section still starts hidden (uses the same class or ID override if needed) */
  #cities {
    display: none !important;
  }
  #map2, #map3, #map4 {
    display: none;
  }
  #climate_name {
    margin-top: -27px;
  }
  .climatecode {
    margin-top: -50px;
  }
  .buttons-with-code > .climate-code {
    transform: translateY(-35px);
  }

  #climatemedia iframe {
    max-width: 100%;
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    display: block;
    margin: 0 auto 18px;
  }

  @media (min-width: 900px) {
    #climatemedia > img {
      display: inline-block !important;
      margin-left: 1%;
      margin-right: 1%;
    }
    .three {
    width: 31%;
    height: auto;
    }
  }

  @media (max-width: 899px) {
    img {
      margin-bottom: 1em;
    }
  }

  @media (max-width: 1400px) {
    body[class*="climate-"] #ariditySection[hidden] {
      display: none !important;
    }
    #ariditySection {
      display: block !important;
      grid-column: 1 / span 2;   /* full width */
      grid-row: 3;               /* below the arrows */
      justify-self: center;
      margin-top: 10px;
      margin-bottom: -250px;;
    }
    #ariditySection[hidden] {
      margin-top: -120px !important;
      margin-bottom: -120px !important;
    }
    .box {
      transform: scale(.75); 
      position: relative;
      top: -80px; 
    }
    /* 2 × 2 grid */
    .buttons-with-code {
      grid-template-columns: 1fr 1fr;
      row-gap: 30px;
      column-gap: 30px;
    }
    .buttons-group,
    .buttons-group_right {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }
    /* explicit placement */
    #climate_go_to_hotter_summer { grid-column: 1; grid-row: 1; }
    #climate_go_to_colder_summer { grid-column: 2; grid-row: 1; }
    #climate_go_to_hotter_winter { grid-column: 1; grid-row: 2; }
    #climate_go_to_colder_winter { grid-column: 2; grid-row: 2; }
    .year-row {
        display: grid;
        grid-template-columns: repeat(2, auto);
        justify-content: center;
        gap: 30px;
    }
  }

  #ariditySection[hidden] {
    display: block !important;   /* keep its size */
    visibility: hidden !important;  /* but make it invisible */
  }

  #usaSection {
    margin-top: -15px;
  }

  /* Bb2 exception */
  body.climate-Bb2 .year-btn {
    background: white !important;
  }

  </style>
</head>
<body>
  <div id="header">
    <p>The Dickinson Climate Classification</p>
  </div>

  <nav>
    <a href="home.html">Home</a>
    <a href="classification.html">Classification</a>
    <a href="maps.html">Maps</a>
    <a href="about.html">About</a>
  </nav>

  <main>
    <h1 id="climate_name"></h1>

    <div class="climate-code">
      <h2><strong id="climate_exists"></strong></h2>
    </div>

    <div class="buttons-with-code">
      <div class="buttons-group">
        <button class="warmer" id="climate_go_to_hotter_summer">◄ Warmer Summers</button>
        <button class="warmer" id="climate_go_to_hotter_winter">◄ Warmer Winters</button>
      </div>
      <div class="box" id="ariditySection" hidden>
        <div class="ariditybox-border-outer">
          <div class="ariditybox-border-inner">
            <div class="ariditybox-grid">
              <button id="climate_go_to_humid"           class="ariditybox ariditybox-humid">Humid (H)</button>
              <button id="climate_go_to_semihumid"       class="ariditybox ariditybox-semihumid">Semihumid (G)</button>
              <button id="climate_go_to_monsoon"         class="ariditybox ariditybox-monsoon">Monsoon<br><br>(W)</button>
              <button id="climate_go_to_mediterranean"   class="ariditybox ariditybox-mediterranean">Mediter-<br>ranean<br><br>(M)</button>
              <button id="climate_go_to_semiarid"        class="ariditybox ariditybox-semiarid">Semiarid (S)</button>
              <button id="climate_go_to_arid_desert"     class="ariditybox ariditybox-arid-desert">Arid (D)</button>
            </div>
          </div>
        </div>
      </div>
      <div class="buttons-group buttons-group_right">
        <button class="colder" id="climate_go_to_colder_summer">Colder Summers ►</button>
        <button class="colder" id="climate_go_to_colder_winter">Colder Winters ►</button>
      </div>
    </div>

    <!-- Global maps -->
    <div id="globalSection">
      <h3 class="map-caption">Global distribution of this climate (projections are RCP8.5 high emissions normals)</h3>
      <div class="year-row" style="text-align:center; margin:10px 0;">
        <button id="gbtn1" class="year-btn" onclick="showMapGlobal(1)">1981 - 2010</button>
        <button id="gbtn2" class="year-btn" onclick="showMapGlobal(2)">2011 - 2040</button>
        <button id="gbtn3" class="year-btn" onclick="showMapGlobal(3)">2041 - 2070</button>
        <button id="gbtn4" class="year-btn" onclick="showMapGlobal(4)">2071 - 2100</button>
      </div>
      <div id="map1"><img id="climate_map_1"></div>
      <div id="map2"><img id="climate_map_2"></div>
      <div id="map3"><img id="climate_map_3"></div>
      <div id="map4"><img id="climate_map_4"></div>
    </div>

    <!-- USA maps -->
    <div id="usaSection">
      <h3 class="map-caption">United States distribution of this climate (projections are RCP8.5 high emissions normals)</h3>
      <div class="year-row" style="text-align:center; margin:10px 0;">
        <button id="ubtn1" class="year-btn" onclick="showMapUSA(1)">1981 - 2010</button>
        <button id="ubtn2" class="year-btn" onclick="showMapUSA(2)">2011 - 2040</button>
        <button id="ubtn3" class="year-btn" onclick="showMapUSA(3)">2041 - 2070</button>
        <button id="ubtn4" class="year-btn" onclick="showMapUSA(4)">2071 - 2100</button>
      </div>
      <div id="map1usa"><img id="climate_map_1_usa"></div>
      <div id="map2usa"><img id="climate_map_2_usa"></div>
      <div id="map3usa"><img id="climate_map_3_usa"></div>
      <div id="map4usa"><img id="climate_map_4_usa"></div>
    </div>

    <div id="climatemedia"></div>

    <div id="cities">
      <div id="cities1" class="cities-block">
        <h3>Places with this climate (1981 - 2010 normals)</h3>
        <ul id="climate_cities1"></ul>
      </div>
      <div id="cities2" class="cities-block">
        <h3>Places with this climate (2011 - 2040 normals)</h3>
        <ul id="climate_cities2"></ul>
      </div>
      <div id="cities3" class="cities-block">
        <h3>Places with this climate (2041 - 2070 normals)</h3>
        <ul id="climate_cities3"></ul>
      </div>
      <div id="cities4" class="cities-block">
        <h3>Places with this climate (2071 - 2100 normals)</h3>
        <ul id="climate_cities4"></ul>
      </div>
    </div>

  <script>
    // --- helpers ---
    function showMapGlobal(n) {
      // hide maps
      for (let i = 1; i <= 4; i++) {
        const m = document.getElementById('map' + i);
        if (m) m.style.display = 'none';
      }

      // show chosen
      const chosen = document.getElementById('map' + n);
      if (chosen) chosen.style.display = 'block';

      // update buttons
      for (let i = 1; i <= 4; i++) {
        const btn = document.getElementById('gbtn' + i);
        if (!btn) continue;
        btn.classList.toggle('active', i === n);
      }
    }

    function showMapUSA(n) {
      for (let i = 1; i <= 4; i++) {
        const m = document.getElementById('map' + i + 'usa');
        if (m) m.style.display = 'none';
      }

      const chosen = document.getElementById('map' + n + 'usa');
      if (chosen) chosen.style.display = 'block';

      for (let i = 1; i <= 4; i++) {
        const btn = document.getElementById('ubtn' + i);
        if (!btn) continue;
        btn.classList.toggle('active', i === n);
      }
    }

    function change_climate(nextCode) {
      window.location.href = window.location.pathname + '?code=' + nextCode;
    }

    function trackAndGo(label, dest) {
      gtag('event', 'select_content', {
        content_type: 'climate_nav',
        item_id: dest,
        link_label: label,
        from_code: document.getElementById('climate_code')?.textContent || ''
      });
      // Navigate on next tick so the event queues
      setTimeout(() => change_climate(dest), 0);
    }

    function wireSection(sectionId, imgId, url) {
      return new Promise(resolve => {
        const section = document.getElementById(sectionId);
        const img = document.getElementById(imgId);
        if (!section || !img) return resolve(false);

        section.style.display = 'none';

        if (!url || String(url).trim() === '') {
          // no URL provided => treat as missing
          section.remove();
          return resolve(false);
        }

        img.onload = () => {
          const ok = img.naturalWidth > 0 && img.naturalHeight > 0;
          if (ok) {
            section.style.display = '';
            resolve(true);
          } else {
            section.remove();
            resolve(false);
          }
        };

        img.onerror = () => {
          section.remove();
          resolve(false);
        };

        img.decoding = 'async';
        img.loading = 'eager';
        img.src = url;
      });
    }

    // --- main ---
    const codeParam = new URLSearchParams(location.search).get('code');
    if (!codeParam) throw new Error("No climate code specified in URL");

    fetch('data/data.json?v=' + Date.now(), { cache: 'no-store' })
      .then(r => r.json())
      .then(data => {
        // exact match first, then case-insensitive fallback
        let climate = data[codeParam];
        if (!climate) {
          const wanted = codeParam.toLowerCase();
          const k = Object.keys(data).find(key => key.toLowerCase() === wanted);
          if (k) climate = data[k];
        }
        if (!climate) throw new Error(`Climate code '${codeParam}' not found in data.json`);

        const climate_code = climate.code; // canonical case from data.json
        // add page-level hook for CSS overrides
        document.body.classList.add('climate-' + climate_code);

        // Map buttons color selecter
        const aridityLetter = climate_code.charAt(1);
        const aridityMap = {
          h: 'humid',
          g: 'semihumid',
          w: 'monsoon',
          m: 'mediterranean',
          s: 'semiarid',
          d: 'arid',
          b: 'cold',
          c: 'cold',
          Y: 'cold'
        };
        const aridityClass = aridityMap[aridityLetter];
        if (aridityClass) {
          document.querySelectorAll('button')
            .forEach(btn => btn.classList.add(aridityClass));
        }
        
        const currentAridityButton = {
          h: 'climate_go_to_humid',
          g: 'climate_go_to_semihumid',
          w: 'climate_go_to_monsoon',
          m: 'climate_go_to_mediterranean',
          s: 'climate_go_to_semiarid',
          d: 'climate_go_to_arid_desert'
        };

        const btnId = currentAridityButton[aridityLetter];
        if (btnId) {
          const btn = document.getElementById(btnId);
          if (btn) btn.classList.add('current');
        }

        // --- Cities: load from data/cities.json and populate lists ---
        (function loadCities() {
          fetch('data/cities.json?v=' + Date.now(), { cache: 'no-store' })
            .then(r => r.json())
            .then(allCities => {
              const citiesWrap = document.getElementById('cities');
              const entry = allCities[climate_code] || allCities[climate_code.toLowerCase()] || allCities[climate_code.toUpperCase()];
              if (!entry) return; // nothing for this code

              let any = false;

              const fill = (ulId, arr) => {
                const ul = document.getElementById(ulId);
                if (!ul) return;

                // de-dup + sort
                const items = Array.from(new Set(arr || [])).sort((a, b) => a.localeCompare(b));

                if (items.length === 0) {
                  // hide the whole block if empty
                  const block = ul.closest('.cities-block');
                  if (block) block.remove();
                  return;
                }

                any = true;
                items.forEach(name => {
                  const li = document.createElement('li');
                  li.textContent = name;
                  ul.appendChild(li);
                });
              };

              // Periods 1–4
              fill('climate_cities1', entry["1"]);
              fill('climate_cities2', entry["2"]);
              fill('climate_cities3', entry["3"]);
              fill('climate_cities4', entry["4"]);

              // Only show the section if any list had items.
              if (any && citiesWrap) {
                // Your CSS has: #cities { display: none !important; }
                // Override it explicitly with !important:
                citiesWrap.style.setProperty('display', 'block', 'important');
              }
            })
            .catch(err => console.warn('Cities load failed:', err));
        })();

        document.getElementById('climate_name').innerHTML = `<strong>${climate_code}</strong>: ${climate.name}`;

        const isGroup = !!climate.group;

        // ---- GA4 tracking for this generated page ----
        const pageTitle = `${climate.name}${isGroup ? ' Climate Group' : ' Climate'} (${climate_code}) – Dickinson CCS`;
        document.title = pageTitle;

        // Keep full URL for page_location; use a stable path+query for page_path
        const pagePath = `${location.pathname}?code=${encodeURIComponent(climate_code)}`;

        gtag('event', 'page_view', {
          page_title: pageTitle,
          page_location: location.href,
          page_path: pagePath
        });

        // Optional: custom event for easy filtering
        gtag('event', 'view_climate', {
          climate_code: climate_code,
          climate_name: climate.name,
          is_group: isGroup,
          exists: !!climate.exists
        });

        document.querySelectorAll('.map-caption').forEach(caption => {
          caption.innerHTML = caption.innerHTML.replace(
            'Global distribution of this climate',
            isGroup ? 'Global distribution of this climate group' : 'Global distribution of this climate'
          ).replace(
            'United States distribution of this climate',
            isGroup ? 'United States distribution of this climate group' : 'United States distribution of this climate'
          );
        });

        // Nav buttons
        [
          ['climate_go_to_hotter_summer','go_to_hotter_summer'],
          ['climate_go_to_colder_summer','go_to_colder_summer'],
          ['climate_go_to_hotter_winter','go_to_hotter_winter'],
          ['climate_go_to_colder_winter','go_to_colder_winter'],
        ].forEach(([btnId, key]) => {
          const btn = document.getElementById(btnId);
          const dest = climate[key];
          if (dest && dest !== "False") btn.onclick = () => trackAndGo(btn.textContent.trim(), dest);
          else btn.disabled = true;
        });

        // Aridity buttons (H, G, W, M, S, D)
        [
          ['climate_go_to_humid',         'go_to_humid'],
          ['climate_go_to_semihumid',     'go_to_semihumid'],
          ['climate_go_to_monsoon',       'go_to_monsoon'],
          ['climate_go_to_mediterranean', 'go_to_mediterranean'],
          ['climate_go_to_semiarid',      'go_to_semiarid'],
          ['climate_go_to_arid_desert',   'go_to_arid_desert'],
        ].forEach(([btnId, key]) => {
          const btn  = document.getElementById(btnId);
          if (!btn) return; // safety

          const dest = climate[key];
          if (dest && dest !== "False") {
            btn.onclick = () => trackAndGo(btn.textContent.trim(), dest);
          } else {
            btn.disabled = true;
          }
        });

        // --- Media embeds ---
        fetch('data/climatemedia.json')
          .then(r => r.json())
          .then(t => {
            const m = t[climate_code]?.media;
            if (m) {
              const el = document.getElementById('climatemedia');
              el.innerHTML = "<br>" + m.join('') + "<br>";
            }
          });

        // Build default map paths using exact case
        const MAP_DIR = 'images/maps';
        const USA_DIR = `images/maps/usa`;
        const g = n => `${MAP_DIR}/${climate_code}-map${n}.png`;
        const u = n => `${USA_DIR}/${climate_code}-map${n}usa.png`;

        // Global
        Promise.all([
          wireSection('map1', 'climate_map_1',  climate.map1  || g(1)),
          wireSection('map2', 'climate_map_2',  climate.map2  || g(2)),
          wireSection('map3', 'climate_map_3',  climate.map3  || g(3)),
          wireSection('map4', 'climate_map_4',  climate.map4  || g(4)),
        ]).then(results => {
          // grey out buttons with missing maps
          results.forEach((exists, i) => {
            if (!exists) {
              const btn = document.getElementById('gbtn' + (i + 1));
              if (btn) btn.classList.add('disabled');
            }
          });
          const globalSection = document.getElementById('globalSection');
          // find first available map
          const first = results.findIndex(Boolean);
          if (first === -1) {
            if (globalSection) globalSection.remove();
          } else {
            showMapGlobal(first + 1);
          }
        });

        // USA
        Promise.all([
          wireSection('map1usa', 'climate_map_1_usa', climate.map1usa || u(1)),
          wireSection('map2usa', 'climate_map_2_usa', climate.map2usa || u(2)),
          wireSection('map3usa', 'climate_map_3_usa', climate.map3usa || u(3)),
          wireSection('map4usa', 'climate_map_4_usa', climate.map4usa || u(4)),
        ]).then(results => {
          // grey out buttons with missing maps
          results.forEach((exists, i) => {
            if (!exists) {
              const btn = document.getElementById('ubtn' + (i + 1));
              if (btn) btn.classList.add('disabled');
            }
          });
          const usaSection = document.getElementById('usaSection');
          // find first available map
          const first = results.findIndex(Boolean);
          if (first === -1) {
            if (usaSection) usaSection.remove();
          } else {
            showMapUSA(first + 1);
          }
        });

        // Aridity chooser visibility
        const aridityTargets = [
          climate.go_to_humid, climate.go_to_semihumid,
          climate.go_to_monsoon, climate.go_to_mediterranean,
          climate.go_to_semiarid, climate.go_to_arid_desert
        ];
        const anyAridity = aridityTargets.some(v => v && v !== "False");
        const aridityLetters = ['h','g','s','d','m','w'];
        document.getElementById('ariditySection').hidden =
          !(climate.exists && (climate.group || aridityLetters.includes(aridityLetter)));

        // Non-existent page: show banner and remove optional UI
        if (!climate.exists) {
          document.getElementById('climate_exists').textContent =
            `THIS ${climate.group ? 'CLIMATE GROUP' : 'CLIMATE'} DOES NOT EXIST`;
          [
            'climatemedia',
            'map1','map2','map3','map4',
            'map1usa','map2usa','map3usa','map4usa'
          ].forEach(id => { const el = document.getElementById(id); if (el) el.remove(); });
        }
      })
      .catch(err => { console.error(err); alert(err.message); });
  </script>
</body>
</html>
